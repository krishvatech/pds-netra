version: "3.8"

services:
  pds_netra_edge:
    build:
      context: .
      dockerfile: docker/Dockerfile.jetson
    restart: unless-stopped
    env_file:
      - /opt/pds-netra-edge/.env
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,video,graphics
      - EDGE_OUTBOX_DB_PATH=/opt/app/data/outbox.db
      - EDGE_WATCHDOG_HEARTBEAT_PATH=/opt/app/data/edge_health.json
    volumes:
      - /opt/pds-netra-edge/config:/opt/app/config
      - /opt/pds-netra-edge/data:/opt/app/data
    runtime: nvidia
    device_requests:
      - driver: nvidia
        count: all
        capabilities: [gpu]
    command: python -m app.main --config /opt/app/config/pds_netra_config.yaml --device cuda --preflight-on-start
    healthcheck:
      test: ["CMD-SHELL", "test -f /opt/app/data/edge_health.json && find /opt/app/data/edge_health.json -mmin -2 | grep -q edge_health.json"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s
