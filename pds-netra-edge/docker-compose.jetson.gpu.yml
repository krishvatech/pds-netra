services:
  mosquitto:
    image: eclipse-mosquitto:2
    restart: unless-stopped
    ports:
      - "1883:1883"
    volumes:
      - ./docker/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro

  pds-edge:
    build:
      context: .
      dockerfile: docker/Dockerfile.jp6
    restart: unless-stopped
    working_dir: /opt/app
    env_file:
      - .env
    environment:
      - GODOWN_ID=${GODOWN_ID}
      - EDGE_BACKEND_TOKEN=${EDGE_BACKEND_TOKEN}
      - MQTT_BROKER_HOST=${MQTT_BROKER_HOST}
      - MQTT_BROKER_PORT=${MQTT_BROKER_PORT}
      - MQTT_USERNAME=${MQTT_USERNAME}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility,graphics
      - EDGE_CAMERAS_SOURCE=backend
      - EDGE_RULES_SOURCE=backend
      - EDGE_BACKEND_URL=https://cv.krishvatech.com
      - EDGE_TIMEZONE=Asia/Kolkata
      - YOLO_CONFIG_DIR=/opt/app/.cache/Ultralytics
      - EDGE_FIRE_DEVICE=cuda:0
      - EDGE_LIVE_ANNOTATED_DIR=/live
      - EDGE_OVERRIDE_DIR=/opt/app/data/edge_overrides
      - EDGE_SNAPSHOT_DIR=/opt/app/data/snapshots
      - EDGE_CAMERA_STARTUP_GRACE_SEC=120
      - EDGE_HEALTH_MIN_FPS_DEFAULT=0.5
      - EDGE_HEALTH_NO_FRAME_TIMEOUT_DEFAULT=45
      # Optional person pipeline mode: yolo | deepstream
      - EDGE_PERSON_PIPELINE=${EDGE_PERSON_PIPELINE:-yolo}
      # DeepStream settings (required when EDGE_PERSON_PIPELINE=deepstream)
      - EDGE_DEEPSTREAM_NVINFER_CONFIG=${EDGE_DEEPSTREAM_NVINFER_CONFIG:-}
      - EDGE_DEEPSTREAM_TRACKER_ENABLED=${EDGE_DEEPSTREAM_TRACKER_ENABLED:-true}
      - EDGE_DEEPSTREAM_TRACKER_CONFIG=${EDGE_DEEPSTREAM_TRACKER_CONFIG:-}
      - EDGE_DEEPSTREAM_PERSON_CLASS_IDS=${EDGE_DEEPSTREAM_PERSON_CLASS_IDS:-0}
      - EDGE_DEEPSTREAM_INFER_WIDTH=${EDGE_DEEPSTREAM_INFER_WIDTH:-1280}
      - EDGE_DEEPSTREAM_INFER_HEIGHT=${EDGE_DEEPSTREAM_INFER_HEIGHT:-720}
      - EDGE_DEEPSTREAM_DETECT_TIMEOUT_SEC=${EDGE_DEEPSTREAM_DETECT_TIMEOUT_SEC:-0.2}
      # Optional line-cross analytics flags
      - EDGE_PERSON_LINE_CROSS_ENABLED=${EDGE_PERSON_LINE_CROSS_ENABLED:-false}
      - EDGE_PERSON_LINE=${EDGE_PERSON_LINE:-}
      - EDGE_PERSON_LINE_ID=${EDGE_PERSON_LINE_ID:-line_1}
      - EDGE_PERSON_LINE_COOLDOWN_SEC=${EDGE_PERSON_LINE_COOLDOWN_SEC:-8}
      - EDGE_PERSON_LINE_MIN_MOTION_PX=${EDGE_PERSON_LINE_MIN_MOTION_PX:-6}
      - EDGE_PERSON_ROI_EVENTS_ENABLED=${EDGE_PERSON_ROI_EVENTS_ENABLED:-false}
      - EDGE_PERSON_ROI_ZONE_ID=${EDGE_PERSON_ROI_ZONE_ID:-}
      - EDGE_PERSON_ROI_POLYGON=${EDGE_PERSON_ROI_POLYGON:-}

    runtime: nvidia
    command: python3 -m app.main --config config/pds_netra_config.yaml --device cuda:0
    volumes:
      - ./:/opt/app
      - ${EDGE_SNAPSHOT_HOST_DIR:-/data/pds-backend/snapshots}:/opt/app/data/snapshots
      - ./data/ultralytics:/opt/app/.cache/Ultralytics
      - ./data/insightface:/root/.insightface
      - ./data/paddleocr:/root/.paddleocr
      - ./data/paddlex:/root/.paddlex
      - /data/pds-live:/live
      - /data/pds-backend/edge_overrides:/opt/app/data/edge_overrides:ro
      - /data/pds-backend/uploads:/opt/app/data/uploads:ro
    depends_on:
      - mosquitto

  pds-edge-deepstream:
    profiles: ["deepstream"]
    build:
      context: .
      dockerfile: docker/Dockerfile.deepstream.jp6
      args:
        - DEEPSTREAM_IMAGE=${EDGE_DEEPSTREAM_IMAGE:-nvcr.io/nvidia/deepstream:6.4-samples-multiarch}
    restart: unless-stopped
    working_dir: /opt/app
    env_file:
      - .env
    environment:
      - GODOWN_ID=${GODOWN_ID}
      - EDGE_BACKEND_TOKEN=${EDGE_BACKEND_TOKEN}
      - MQTT_BROKER_HOST=${MQTT_BROKER_HOST}
      - MQTT_BROKER_PORT=${MQTT_BROKER_PORT}
      - MQTT_USERNAME=${MQTT_USERNAME}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility,graphics
      - EDGE_CAMERAS_SOURCE=backend
      - EDGE_RULES_SOURCE=backend
      - EDGE_BACKEND_URL=https://cv.krishvatech.com
      - EDGE_TIMEZONE=Asia/Kolkata
      - YOLO_CONFIG_DIR=/opt/app/.cache/Ultralytics
      - EDGE_FIRE_DEVICE=cuda:0
      - EDGE_LIVE_ANNOTATED_DIR=/live
      - EDGE_OVERRIDE_DIR=/opt/app/data/edge_overrides
      - EDGE_SNAPSHOT_DIR=/opt/app/data/snapshots
      - EDGE_CAMERA_STARTUP_GRACE_SEC=120
      - EDGE_HEALTH_MIN_FPS_DEFAULT=0.5
      - EDGE_HEALTH_NO_FRAME_TIMEOUT_DEFAULT=45
      - EDGE_PERSON_PIPELINE=deepstream
      - EDGE_DEEPSTREAM_NVINFER_CONFIG=${EDGE_DEEPSTREAM_NVINFER_CONFIG:-/opt/nvidia/deepstream/deepstream/samples/configs/deepstream-app/config_infer_primary.txt}
      - EDGE_DEEPSTREAM_TRACKER_ENABLED=${EDGE_DEEPSTREAM_TRACKER_ENABLED:-true}
      - EDGE_DEEPSTREAM_TRACKER_CONFIG=${EDGE_DEEPSTREAM_TRACKER_CONFIG:-/opt/nvidia/deepstream/deepstream/samples/configs/deepstream-app/config_tracker_NvDCF_perf.yml}
      - EDGE_DEEPSTREAM_PERSON_CLASS_IDS=${EDGE_DEEPSTREAM_PERSON_CLASS_IDS:-0}
      - EDGE_DEEPSTREAM_INFER_WIDTH=${EDGE_DEEPSTREAM_INFER_WIDTH:-1280}
      - EDGE_DEEPSTREAM_INFER_HEIGHT=${EDGE_DEEPSTREAM_INFER_HEIGHT:-720}
      - EDGE_DEEPSTREAM_DETECT_TIMEOUT_SEC=${EDGE_DEEPSTREAM_DETECT_TIMEOUT_SEC:-0.2}
      - EDGE_PERSON_LINE_CROSS_ENABLED=${EDGE_PERSON_LINE_CROSS_ENABLED:-false}
      - EDGE_PERSON_LINE=${EDGE_PERSON_LINE:-}
      - EDGE_PERSON_LINE_ID=${EDGE_PERSON_LINE_ID:-line_1}
      - EDGE_PERSON_LINE_COOLDOWN_SEC=${EDGE_PERSON_LINE_COOLDOWN_SEC:-8}
      - EDGE_PERSON_LINE_MIN_MOTION_PX=${EDGE_PERSON_LINE_MIN_MOTION_PX:-6}
      - EDGE_PERSON_ROI_EVENTS_ENABLED=${EDGE_PERSON_ROI_EVENTS_ENABLED:-false}
      - EDGE_PERSON_ROI_ZONE_ID=${EDGE_PERSON_ROI_ZONE_ID:-}
      - EDGE_PERSON_ROI_POLYGON=${EDGE_PERSON_ROI_POLYGON:-}

    runtime: nvidia
    command: python3 -m app.main --config config/pds_netra_config.yaml --device cuda:0
    volumes:
      - ./:/opt/app
      - ${EDGE_SNAPSHOT_HOST_DIR:-/data/pds-backend/snapshots}:/opt/app/data/snapshots
      - ./data/ultralytics:/opt/app/.cache/Ultralytics
      - ./data/insightface:/root/.insightface
      - ./data/paddleocr:/root/.paddleocr
      - ./data/paddlex:/root/.paddlex
      - /data/pds-live:/live
      - /data/pds-backend/edge_overrides:/opt/app/data/edge_overrides:ro
      - /data/pds-backend/uploads:/opt/app/data/uploads:ro
    depends_on:
      - mosquitto
