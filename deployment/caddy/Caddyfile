{$CADDY_DOMAIN} {
    encode gzip

    @latest_live_jpg path_regexp latest_live_jpg ^/media/live/[^/]+/[^/]+_latest\.jpg$
    header @latest_live_jpg Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
    header @latest_live_jpg Pragma "no-cache"
    header @latest_live_jpg Expires "0"

    # Keep all backend APIs on FastAPI directly.
    # This removes an extra Next.js hop and reduces memory/CPU pressure.
    handle /api/v1/* {
        reverse_proxy backend:8001
    }

    # Media served by backend.
    handle /media/* {
        reverse_proxy backend:8001
    }

    # Everything else to dashboard (Next.js).
    handle {
        reverse_proxy dashboard:3000
    }

    tls {$CADDY_EMAIL}
}
