{$CADDY_DOMAIN} {
    encode gzip

    @latest_live_jpg path_regexp latest_live_jpg ^/media/live/[^/]+/[^/]+_latest\.jpg$
    header @latest_live_jpg Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
    header @latest_live_jpg Pragma "no-cache"
    header @latest_live_jpg Expires "0"

    # Use ordered handles so auth/webhook endpoints are guaranteed
    # to bypass dashboard and hit backend directly.
    handle /api/v1/meta/webhook/* {
        reverse_proxy backend:8001
    }

    handle /api/v1/auth/* {
        reverse_proxy backend:8001
    }

    # Route all other v1 API calls through Next.js API proxy.
    # This allows cookie session -> Authorization header translation.
    handle /api/v1/* {
        reverse_proxy dashboard:3000
    }

    # Media served by backend.
    handle /media/* {
        reverse_proxy backend:8001
    }

    # Everything else to dashboard (Next.js).
    handle {
        reverse_proxy dashboard:3000
    }

    tls {$CADDY_EMAIL}
}
