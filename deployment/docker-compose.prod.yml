services:
  backend:
    build:
      context: ../pds-netra-backend
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file:
      - ./env/backend.env
    mem_limit: 512m
    environment:
      ENABLE_MQTT_CONSUMER: "false"
      ENABLE_DISPATCH_WATCHDOG: "false"
      ENABLE_DISPATCH_PLAN_SYNC: "false"
      AUTO_SEED_CAMERAS_FROM_EDGE: "false"
    volumes:
      - ./data/backend:/opt/app/data

  backend-worker:
    build:
      context: ../pds-netra-backend
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file:
      - ./env/backend.env
    mem_limit: 384m
    environment:
      ENABLE_MQTT_CONSUMER: "false"
      ENABLE_DISPATCH_WATCHDOG: "false"
      ENABLE_DISPATCH_PLAN_SYNC: "false"
      AUTO_SEED_CAMERAS_FROM_EDGE: "false"
    depends_on:
      - backend
    command: ["python", "-m", "app.worker"]
  
  migrate:
    build:
      context: ../pds-netra-backend
      dockerfile: Dockerfile
    env_file:
      - ./env/backend.env
    command: ["python", "-m", "app.scripts.run_migrations"]
    profiles: ["migrate"]
    environment:
      ENABLE_MQTT_CONSUMER: "false"

  dashboard:
    build:
      context: ../pds-netra-dashboard
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file:
      - ./env/dashboard.env
    mem_limit: 768m
    environment:
      NODE_OPTIONS: --max-old-space-size=384
      BACKEND_INTERNAL_API_BASE_URL: http://backend:8001
    depends_on:
      - backend

  caddy:
    image: caddy:2
    restart: unless-stopped
    mem_limit: 384m
    env_file:
      - ./.env
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./caddy/data:/data
      - ./caddy/config:/config
    depends_on:
      - dashboard
      - backend
